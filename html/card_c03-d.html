<!DOCTYPE HTML>
<html>
  <head>
    <title>Card prototype</title>
    
    <!-- Filter -->
    <style>*{}</style>
    
    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,300&subset=latin,greek,latin-ext' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400,700&subset=latin,greek,latin-ext" rel="stylesheet">
    
    <!-- Main -->
    <link href="../css/card_c03-d.css" rel="stylesheet">
  </head>
  <body>
    
    <header>
      <div id="searchBar" tabindex="-1">
	<span class="material-icons" tabindex="-1">search</span>
	<input type="text" placeholder="Search for PMCID, genus or species"/>
	<span class="material-icons" tabindex="-1">close</span>
      </div>
    </header>
    
    <main>
      
      <section id="articles">
	<header>Articles</header>
	<main></main>
	<footer></footer>
      </section>
      
      <section id="genera">
	<header>Genus</header>
	<main></main>
	<footer></footer>
      </section>
      
      <section id="species">
	<header>Species</header>
	<main></main>
	<footer></footer>
      </section>
      
    </main>
  
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<!--     <script type="text/javascript" src="https://larsgw.github.io/citation.js/src/Citation-0.1.js"></script> -->
    <script type="text/javascript">

var publisherIcon = {
  'Frontiers in plant science':'https://api-journal.frontiersin.org/Areas/Header/Content/Images/thin-header-logo.png',
  'Frontiers in zoology':'https://api-journal.frontiersin.org/Areas/Header/Content/Images/thin-header-logo.png',
  
  'PloS one':'https://plos.org/images/favicon.ico'
}

var articles = 50
  , genera   = 250
  , binomial = 250
  
  , getdata
  , sections
  , uri = getURI()

var stylesheets = {
  filter: document.styleSheets[ 0 ]
}

function getURI () {
  var res   = {}
    , param = window.location.hash.replace( /^#/, '' )
    
  if ( param )
    param = param.split( '&' )
  
  else
    param = [];
    
  for ( var i = 0; i < param.length; i++ )
    res[ param[ i ].split( '=' )[ 0 ] ] = decodeURIComponent( param[ i ].split( '=' )[ 1 ] );
  
  return res
}

function checkHash () {
  uri = getURI ()
  
  if ( uri.article )
    filter( uri.article, 'articles' )
  
  else if ( uri.genus )
    filter( uri.genus, 'genus' )
  
  else if ( uri.species )
    filter( uri.species, 'species' )
}

function filter ( value, prop ) {
  var prop = prop || 'articles';
  stylesheets.filter.deleteRule( 0 )
  stylesheets.filter.insertRule( 
    '.card:not([data-' + prop + '~="' + value + '"]){' +
      'max-height:0;' +
      'margin-top:0;' +
      'margin-bottom:0;' +
      'padding:0;' +
    '}'
  , 0 )
}

$(document).ready(function(){
  sections = $( 'body > main > section' ).addClass('shadow-top');
  
  checkHash()
})

$(window).on('load',function(){
  
  $.get( 'data/c03-a.json', function ( data ) {
    
    getdata = data;
    
    $( '#articles > main' ).append( Object.keys( data.articles ).slice( 0, articles ).map( function ( v, i ) {
      var article = data.articles[ v ]
        , footer  = $( '#articles > footer' )
      
      if ( i < articles )
	footer.html( i + '/' + articles )
      else
	footer.empty()
      
      return (
	'<div class="card" tabindex="-1" '+
	  'data-articles="' + v + '"' +
	  'data-genus="' + article.genera.join( ' ' ) + '"' +
	  'data-species="' + article.species.map( function ( v ) { return v.replace( ' ', '_' ) } ).join( ' ' ) + '"' +
	'>' +
	  '<header>' +
	    '<h1><a href="#article=' + v + '">' + article.title + '</a></h1>' +
	    '<section>' +
	      '<p>' +
		[
		  '<span><a href="https://doi.org/' + article.doi + '">' + article.doi + '</a></span>' ,
		  '<span>' + article.journal + '</span>'
		].join( '<br>' ) +
	      '</p>' +
	    '</section>' +
	  '</header>' +
// 	  '<img src="' + publisherIcon[ article.journal ] + '">' +
	  '<main>' +
	    article.abstract +
	  '</main>'+
	'</div>' )
      
    } ).join( '' ) )
    
    $( '#genera > main' ).append( Object.keys( data.genus ).slice( 0, genera ).map( function ( genus, index ) {
      var genusData = data.genus[ genus ]
        , footer  = $( '#genera > footer' )
      
      if ( index < genera )
	footer.html( index + '/' + genera )
      else
	footer.empty()
      
      return (
	'<div class="card" tabindex="-1" style="order:' + genusData.order + ';" ' +
	  'data-articles="' + genusData.hits.map( function(v){ return v[ 0 ] } ).join( ' ' ) + '"' +
	  'data-genus="' + genus + '"' +
	  'data-species="' + genusData.species.map( function ( v ) { return v.replace( ' ', '_' ) } ).join( ' ' ) + '"' +
	'>' +
	  '<header>' +
	    '<h1>' +
	      '<span class="title"><a href="#genus=' + genus + '">' + genus + '</a></span>' +
	      '<span class="total">' + genusData.total + '</span>' +
	    '</h1>' +
	    '<section>' +
	      '<ul>' +
		genusData.species.map( function ( v, i, a ) {
		  var str = '<li><a href="#species=' + v.replace( ' ', '_' ) + '">' + v + '</a></li>'
		  
		  if ( ( a.length > 10 ) && ( i === 8 ) )
		    str += (
		      '<li class="read-more" onclick="' +
			'this.parentNode.style.maxHeight=\'24.285714285714285em\';' +
			'this.parentNode.style.overflowY=\'scroll\';' +
			'this.remove()' +
		      '">Click for more species</li>'
		    )
		  
		  return str
		} ).join( ' ' ) +
	      '</ul>' +
	    '</section>' +
	  '</header>' +
	  '<main>' +
	    '<ul>' +
	      genusData.hits.map( function ( v ) {
		return (
		  '<li>' +
		    '<span class="pmcid"><a href="#article=' + v[ 0 ] + '">' + v[ 0 ] + '</a></span>' +
		    '<span class="count">' + v[ 1 ] + '</span>' +
		  '</li>' )
	      } ).join( '' ) +
	    '</ul>' +
	  '</main>' +
	'</div>' )
      
    } ).join( '' ) )
    
    $( '#species > main' ).append( Object.keys( data.binomial ).slice( 0, binomial ).map( function ( species, index ) {
      var speciesData = data.binomial[ species ]
        , footer  = $( '#species > footer' )
      
      if ( index < binomial )
	footer.html( index + '/' + binomial )
      else
	footer.empty()
      
      return (
	'<div class="card" tabindex="-1" style="order:' + speciesData.order + ';" ' +
	  'data-articles="' + speciesData.hits.map( function ( v ) { return v[ 0 ] } ).join( ' ' ) + '"' +
	  'data-genus="' + species.split( ' ' )[0] + '"' +
	  'data-species="' + species.replace( ' ', '_' ) + '"' +
	'>' +
	  '<header>' +
	    '<h1>' +
	      '<span class="title"><a href="#species=' + species.replace( ' ', '_' ) + '">' + species + '</a></span>' +
	      '<span class="total">' + speciesData.total + '</span>' +
	    '</h1>' +
	    '<section>' +
	      '<ul>' +
	      '</ul>' +
	    '</section>' +
	  '</header>' +
	  '<main>' +
	    '<ul>' +
	      speciesData.hits.map( function ( v ) {
		return (
		  '<li>' +
		    '<span class="pmcid"><a href="#article=' + v[ 0 ] + '">' + v[ 0 ] + '</a></span>' +
		    '<span class="count">' + v[ 1 ] + '</span>' +
		  '</li>' )
	      } ).join( '' ) +
	    '</ul>' +
	  '</main>' +
	  '<footer>' +
	    '<a href="#genus=' + species.split( ' ' )[ 0 ] + '">' + species.split( ' ' )[ 0 ] + '</a>' +
	  '</footer>' +
	'</div>' )
      
    } ).join( '' ) )
    
    $( '.card a' ).click( function () {
      setTimeout( checkHash, 100 )
    } )
    
  });
  
  sections.children('main').scroll( function () {
    var $this = $(this).parent();
    
    $this[ ( this.scrollTop < 5 ? 'add' : 'remove' ) + 'Class' ]('shadow-top')
    $this[ ( this.scrollHeight - this.clientHeight - this.scrollTop < 5 ? 'add' : 'remove' ) + 'Class' ]('shadow-bottom')
  } )
  
  $('#searchBar input').on('change',function(){
    var val = $(this).val();
    
    if ( val.split(' ').length===2 )
      filter(val.replace(' ','_'),'species')
    
    else if ( /^PMC\d+$/.test(val) )
      filter(val,'articles')
    
    else
      filter(val,'genus')
  })
});
    </script>
  </body>
</html>